# 코드 및 데이터 분석 보고서

## 1. `scripts` 디렉토리 코드 분석

`scripts` 디렉토리는 `analysis`, `evaluation`, `preprocess`, `training` 네 개의 하위 디렉토리로 구성되어 있으며, 각 스크립트의 역할은 다음과 같습니다.

### `preprocess` (전처리)
데이터를 분석과 모델 학습에 적합한 형태로 가공하는 스크립트들입니다.

- **`01_process_excel.py`**: `data` 디렉토리의 Excel 파일들을 읽어 중국어 컬럼명을 영어로 변경하고, 필요한 정보를 추출하여 `processed_data` 디렉토리에 JSON 파일로 저장합니다.
- **`02_process_pdf.py`**: `Epidemic_guide.pdf` 파일의 텍스트를 추출하여 JSON 형식으로 저장합니다.
- **`03_unify_and_clean.py`**: `processed_data`에 있는 모든 JSON 파일들을 하나로 통합하고, 숫자 데이터를 정규화하는 등 클리닝 작업을 수행합니다.
- **`04_visualize_data.py`**: 통합된 데이터를 바탕으로 수치형 데이터의 분포, 카테고리형 데이터의 빈도, 텍스트 데이터의 워드 클라우드 등 다양한 시각화 자료를 생성합니다.
- **`05_prepare_for_tuning.py`**: 통합된 데이터를 기반으로 대규모 언어 모델(LLM)의 미세조정(fine-tuning)을 위한 데이터셋을 생성합니다. 지도학습(SFT)과 선호도 학습(RLVR)에 맞는 형식으로 데이터를 가공합니다.
- **`06_advanced_visualization.py`**: 최종 통합 데이터셋에서 '주요 진단' 정보를 바탕으로 희귀 진단을 그룹화하는 등 고급 시각화를 수행합니다.
- **`07_build_final_dataset.py`**: 외래, 영상, EMR 등 특정 데이터 소스를 중심으로 서사(narrative)와 진단명에 초점을 맞춘 최종 데이터셋을 구축합니다.
- **`08_detailed_diagnosis_visualization.py`**: 주요 진단명에 대해 상위 N개 분포, 트리맵, 성별/나이별 분포 등 매우 상세한 시각화를 수행합니다.
- **`09_comprehensive_preprocessing.py`**: 입원, 검사(LIS), 영상(PACS), EMR 등 여러 원본 데이터를 종합하여, 입원 후 첫 72시간 동안의 데이터를 기반으로 분석용 데이터셋(`analysis_ready_data.json`)을 생성하는 포괄적인 전처리 스크립트입니다.
- **`10_split_dataset.py`**: `analysis_ready_data.json` 파일을 환자 ID 기준으로 학습(train), 검증(validation), 테스트(test) 세트로 분할합니다. 데이터 유출을 막고 결과 변수(outcome)의 분포를 유지하며 분할합니다.
- **`11_generate_outcomes.py`**: 각 환자에 대한 결과 변수(Y)를 생성합니다. 여기서는 '중증 결과'를 14일 내 ICU 입원 또는 재입원으로 정의하고, 이를 기반으로 `outcomes.json` 파일을 생성합니다.
- **`11_generate_icu_outcomes.py`**: EMR 데이터의 퇴원 기록 등에서 'ICU' 관련 키워드를 찾아 ICU 입원 여부를 결과 변수로 생성하는, 다른 버전의 결과 생성 스크립트입니다.
- **`12_create_timeseries_dataset.py`**: 분할된 데이터셋을 Temporal Fusion Transformer (TFT)와 같은 시계열 딥러닝 모델에 사용하기 적합한 형태로 변환합니다. 각 환자별로 72시간 시퀀스 데이터를 생성하여 Parquet 파일로 저장합니다.

### `training` (모델 학습)
전처리된 데이터를 사용하여 모델을 학습시키는 스크립트들입니다.

- **`01_train_baseline_slr.py`**: 기본적인 로지스틱 회귀(Logistic Regression) 모델을 학습시킵니다. 특성 공학, 데이터 파이프라인 생성, 모델 학습 및 저장을 수행합니다.
- **`02_train_tft.py`**: 시계열 데이터셋을 사용하여 Temporal Fusion Transformer (TFT) 모델을 학습시키고, 학습된 모델을 저장합니다.

### `evaluation` (모델 평가)
학습된 모델의 성능을 평가하는 스크립트입니다.

- **`01_evaluate_tft.py`**: 학습된 TFT 모델을 테스트 데이터셋으로 평가합니다. AUROC, AUPRC 등 성능 지표를 계산하고, 보정 그래프(calibration plot)를 생성하여 모델의 신뢰도를 평가합니다.

### `analysis` (분석)
데이터 분할 결과를 분석하는 스크립트입니다.

- **`01_inspect_data_split.py`**: 학습, 검증, 테스트 세트 간의 결과 변수 분포가 잘 유지되었는지 확인합니다.

## 2. 데이터 구조 분석

전처리 파이프라인의 핵심 결과물인 두 개의 JSON 파일을 분석하여 데이터 구조를 보고드립니다.

### 1. `final_unified_dataset.json`
이 파일은 `07_build_final_dataset.py` 스크립트에 의해 생성되며, 주로 서사(narrative) 데이터와 진단명 중심으로 구조화되어 있습니다.

**첫 번째 데이터 레코드 예시:**
```json
{
    "source": "outpatient",
    "visit_id": 4000004,
    "department": "心血管内科",
    "visit_time": "2023-01-01T11:20:00",
    "clinical_narrative": "Chief Complaint: 胸闷\nHistory of Present Illness: 활동후흉闷、气促\nPast Medical History: 고혈압병史10년\nPhysical Examination: 神清，精神可，对答切题，浅表淋巴结未扪及肿大，巩膜无黄染，口唇无发绀，颈软，无抵抗，双肺呼吸音清，未闻及干湿性啰音，心率78次/分，律齐，各瓣膜听诊区未闻及病理性杂음，腹平软，无压痛、反跳痛，肝脾肋下未及，双下肢无水肿。",
    "primary_diagnosis": "고혈압병",
    "primary_diagnosis_icd": "I10.x00",
    "medications": [
        {
            "name": "苯磺酸左旋氨氯地平片",
            "dosage_value": 2.5,
            "dosage_unit": "mg",
            "quantity": 1.0
        }
    ]
}
```

**컬럼(Key) 설명:**
- `source`: 데이터 출처 (예: 'outpatient' - 외래)
- `visit_id`: 방문 ID (외래 번호 또는 입원 번호)
- `department`: 진료과
- `visit_time`: 진료 시간
- `clinical_narrative`: 주소(Chief Complaint), 현병력(History of Present Illness) 등을 포함한 임상 서사
- `primary_diagnosis`: 주 진단명
- `primary_diagnosis_icd`: 주 진단명의 ICD 코드
- `medications`: 처방된 약물 정보 (이름, 용량, 단위, 수량)

### 2. `analysis_ready_data.json`
이 파일은 `09_comprehensive_preprocessing.py`에 의해 생성되며, 각 환자의 입원 후 72시간 데이터를 집약하여 모델링에 바로 사용할 수 있도록 만든 데이터입니다.

**첫 번째 데이터 레코드 예시:**
```json
{
    "inpatient_id": "3000001",
    "t0_admission_time": "2023-01-15 09:30:00",
    "meds_atc_list": [
        "N02",
        "J01"
    ],
    "lab_features_packed": {
        "WBC": "1.2|0.5|1",
        "CRP": "-0.3|1.0|0"
    },
    "pacs_summary": "双肺纹理增多，主动脉及冠状动脉钙化",
    "emr_history": "고혈압병史5년，否认糖尿病、冠心病史",
    "demographics": {
        "age": 68,
        "sex": "男"
    }
}
```

**컬럼(Key) 설명:**
- `inpatient_id`: 입원 ID (환자 식별자)
- `t0_admission_time`: 입원 시작 시간 (모든 이벤트의 기준 시점)
- `meds_atc_list`: 72시간 내 투여된 약물의 ATC 코드 리스트
- `lab_features_packed`: 72시간 내 주요 검사 결과의 특성 (첫 측정치의 Z-score, 24시간 변화량, 정상범위 이탈 여부)
- `pacs_summary`: 72시간 내 영상(PACS) 검사 결과 요약
- `emr_history`: EMR에서 추출한 환자의 과거력
- `demographics`: 나이, 성별 등 인구통계 정보

## 3. 원본 데이터 상세 분석 (Excel)

`data` 디렉토리에 위치한 5개의 원본 Excel 파일에 대한 상세 분석입니다. 각 파일의 컬럼 구조와 첫 번째 환자 데이터를 기반으로 작성되었습니다.

### 1. 嘉和EMR数据.xlsx (EMR)

- **파일명**: 嘉和EMR数据.xlsx
- **데이터 크기**: 6.8 MB
- **데이터 수**: 2,321행, 19열

#### 컬럼 분석

| 컬럼명 | 데이터 타입 | 설명 |
| --- | --- | --- |
| 患者姓名 | object | 환자 이름 |
| 住院号 | int64 | 입원 번호 |
| 职业 | object | 직업 |
| 户籍 | object | 호적 |
| 现住详细地址 | object | 현 거주지 상세 주소 |
| 主诉 | object | 주된 호소 (Chief Complaint) |
| 现病史 | object | 현재 병력 |
| 既往史 | object | 과거 병력 |
| 体格检查 | object | 신체 검사 |
| 首次病程记录 | object | 최초 경과 기록 |
| 出院记录 | object | 퇴원 기록 |
| 主诊断 | object | 주 진단명 |
| 主诊断编码 | object | 주 진단 코드 (ICD) |
| 主诊断时间 | datetime64[ns] | 주 진단 시간 |
| 次诊断 | object | 부 진단명 |
| 次诊断编码 | object | 부 진단 코드 (ICD) |
| 次诊断时间 | object | 부 진단 시간 |
| 次诊断医生 | object | 부 진단 의사 |

#### 첫 번째 환자 데이터 (환자 ID: 464564)

- **환자 이름**: 施木兰 (시무란)
- **주요 증상**: 7년 이상 반복되는 관절 통증, 1주간의 피로 및 사지 부종.
- **현재 병력**: 7년 전부터 여러 관절(손목, 무릎, 어깨, 발목)의 부종과 통증, 조조 강직 발생.
- **과거 병력**: 특이사항 없음.
- **주 진단명**: 类风湿性关节炎 (류마티스 관절염)
- **부 진단명**: 다발성 근염, 동성 빈맥, 폐 감염 등 다수.

### 2. PACS影像数据 去身份证.xlsx (영상)

- **파일명**: PACS影像数据 去身份证.xlsx
- **데이터 크기**: 9.0 MB
- **데이터 수**: 40,051행, 23열

#### 컬럼 분석

| 컬럼명 | 데이터 타입 | 설명 |
| --- | --- | --- |
| 患者姓名 | object | 환자 이름 |
| 性别 | object | 성별 |
| 年龄 | object | 나이 |
| 门诊住院号 | object | 외래/입원 번호 |
| 检查号 | object | 검사 번호 |
| 检查日期 | float64 | 검사 날짜 |
| 检查结论 | object | 검사 결론 |
| 检查表现 | object | 검사 소견 |
| 报告日期 | int64 | 보고 날짜 |

#### 첫 번째 환자 데이터 (환자 ID: 0464564)

- **환자 이름**: 施木兰 (시무란)
- **나이**: 59세
- **검사 번호**: CT1599776
- **검사 날짜**: 2021-11-01
- **검사 결론**: 양폐 간질성 병변 및 감염, 폐기종; 심장 비대 및 심낭 삼출액.
- **검사 소견**: 양폐의 질감 증가 및 이상 음영, 다발성 림프절 비대, 심낭 삼출액(약 20mm) 관찰됨.

### 3. LIS 去除身份证.xlsx (진단검사)

- **파일명**: LIS 去除身份证.xlsx
- **데이터 크기**: 24.0 MB
- **데이터 수**: 373,855행, 16열

#### 컬럼 분석

| 컬럼명 | 데이터 타입 | 설명 |
| --- | --- | --- |
| TYPE | object | 검사 타입 (미생물/일반) |
| OUTPATIENT_ID | object | 외래 ID |
| INPATIENT_ID | object | 입원 ID |
| PATIENT_NAME | object | 환자 이름 |
| PATIENT_TYPE | object | 환자 타입 (입원/외래) |
| CLINICAL_DIAGNOSES | object | 임상 진단명 |
| TEST_ORDER_NAME | object | 검사 오더명 |
| INSPECTION_DATE | int64 | 검사 날짜 |
| CHINESE_NAME | object | 검사 항목명 (중문) |
| QUANTITATIVE_RESULT | object | 정량 결과 |
| QUALITATIVE_RESULT | object | 정성 결과 |
| TEST_ITEM_REFERENCE | object | 참고치 |
| TEST_ITEM_UNIT | object | 단위 |

#### 첫 번째 환자 데이터 (환자 ID: 10039122)

- **환자 이름**: 吴语彤 (오어동)
- **나이**: 6세
- **검사 타입**: 미생물
- **임상 진단명**: 支气管肺炎 (기관지 폐렴)
- **검사 항목**: 痰培养(住院) (입원환자 객담 배양)
- **검사 결과**: 奈瑟菌 (나이세리아균)

### 4. HIS住院.xlsx (입원 처방)

- **파일명**: HIS住院.xlsx
- **데이터 크기**: 4.7 MB
- **데이터 수**: 135,634행, 6열

#### 컬럼 분석

| 컬럼명 | 데이터 타입 | 설명 |
| --- | --- | --- |
| 姓名 | object | 환자 이름 |
| 住院号码 | int64 | 입원 번호 |
| 药品医嘱 | object | 약품 처방 |
| 医嘱开始时间 | object | 처방 시작 시간 |
| 医嘱结束时间 | object | 처방 종료 시간 |
| 药品剂量 | object | 약품 용량 |

#### 첫 번째 환자 데이터 (환자 ID: 506186)

- **환자 이름**: 叶博文 (엽박문)
- **약품 처방**: 呋喃硫胺片 (푸르설티아민 정)
- **처방 시작**: 2020-03-18 11:10:12
- **약품 용량**: 12.5mg

### 5. HIS门诊.xlsx (외래 처방)

- **파일명**: HIS门诊.xlsx
- **데이터 크기**: 2.2 MB
- **데이터 수**: 17,943행, 20열

#### 컬럼 분석

| 컬럼명 | 데이터 타입 | 설명 |
| --- | --- | --- |
| 姓名 | object | 환자 이름 |
| 门诊号 | object | 외래 번호 |
| 职业 | object | 직업 |
| 主诉 | object | 주된 호소 |
| 主诊断 | object | 주 진단명 |
| 就诊科室 | object | 진료과 |
| 药品名称 | object | 약품명 |
| 药品剂量 | float64 | 약품 용량 |
| 药品数量 | float64 | 약품 수량 |
| 处方时间 | datetime64[ns] | 처방 시간 |

#### 첫 번째 환자 데이터 (환자 ID: 331102201710130261)

- **환자 이름**: 徐梦婕 (서몽절)
- **직업**: 散居儿童 (미취학 아동)
- **주요 증상**: 구토, 설사 1일, 발열 0.5일
- **주 진단명**: 轮状病毒肠炎 (로타바이러스 장염)
- **진료과**: 儿科门诊 (소아과 외래)
- **처방 약품**: (肯特令)蒙脱石散 (몬모릴로나이트 산제), 1.5g, 5개

## 4. 환자 고유번호 기준 데이터 분석 결과

### 4.1 각 파일별 환자 수 분석

환자 이름이 아닌 **환자 고유번호(입원번호, 외래번호, 검사번호 등)**를 기준으로 각 파일의 고유 환자 수를 분석한 결과입니다.

#### 분석 결과 요약

| 파일명 | 총 레코드 수 | 고유 환자 수 | 완전한 정보 환자 수 | 사용된 고유번호 컬럼 |
|--------|-------------|-------------|-------------------|-------------------|
| EMR (嘉和EMR数据.xlsx) | 2,321 | 2,224 | 2,159 | 住院号 (입원번호) |
| PACS (PACS影像数据 去身份证.xlsx) | 40,051 | 37,323 | 37,319 | 检查号 (검사번호) |
| LIS (LIS 去除身份证.xlsx) | 373,855 | 29,555 | 29,555 | OUTPATIENT_ID (외래환자ID) |
| HIS 입원 (HIS住院.xlsx) | 135,634 | 2,573 | 2,573 | 住院号码 (입원번호) |
| HIS 외래 (HIS门诊.xlsx) | 17,943 | 8,149 | 4,541 | 门诊号 (외래번호) |

#### 주요 발견사항

1. **가장 많은 독립 환자를 보유한 파일**: PACS (37,323명)
2. **가장 많은 총 레코드를 보유한 파일**: LIS (373,855개)
3. **완전한 정보 비율이 가장 높은 파일**: HIS 입원 (100%)
4. **완전한 정보 비율이 가장 낮은 파일**: HIS 외래 (55.7%)

### 4.2 파일 간 환자 중복 분석

#### 교집합 분석 결과

- **모든 파일에 공통으로 나타나는 환자**: 0명
  - 각 파일이 서로 다른 환자 고유번호 체계를 사용하기 때문
  - EMR: 입원번호, PACS: 검사번호, LIS: 외래환자ID, HIS: 입원/외래번호

- **최소 2개 파일에 나타나는 환자**: 9,559명
  - 일부 환자들이 여러 시스템에서 서로 다른 ID로 기록됨

#### 파일별 독립 환자 수

| 파일명 | 해당 파일에만 있는 환자 수 | 비율 |
|--------|-------------------------|------|
| PACS | 37,323명 | 89.2% |
| LIS | 22,104명 | 74.8% |
| HIS 외래 | 698명 | 8.6% |
| HIS 입원 | 465명 | 18.1% |
| EMR | 116명 | 5.2% |

### 4.3 데이터 품질 분석

#### 고유번호 누락 현황

- **EMR**: 0개 (100% 완전)
- **PACS**: 0개 (100% 완전)
- **LIS**: 1,381개 (0.4% 누락)
- **HIS 입원**: 0개 (100% 완전)
- **HIS 외래**: 0개 (100% 완전)

#### 완전한 정보 환자 비율

- **EMR**: 97.1% (2,159/2,224)
- **PACS**: 99.9% (37,319/37,323)
- **LIS**: 100% (29,555/29,555)
- **HIS 입원**: 100% (2,573/2,573)
- **HIS 외래**: 55.7% (4,541/8,149)

### 4.4 시각화 결과

분석 결과를 바탕으로 다음과 같은 영어 시각화 자료가 생성되었습니다:

1. **Unique Patients per File**: 파일별 고유 환자 수 비교
2. **Total Records per File**: 파일별 총 레코드 수 비교
3. **Complete Info Patient Ratio (%)**: 파일별 완전한 정보 환자 비율
4. **Average Records per Patient**: 파일별 환자당 평균 레코드 수

### 4.5 분석 스크립트 정보

- **스크립트 위치**: `scripts/preprocess/00_patient_analysis.py`
- **결과 저장 위치**: 
  - `processed_data/patient_analysis_results.json`
  - `visualizations/patient_analysis_summary.png`
- **주요 기능**:
  - 환자 고유번호 컬럼 자동 탐지
  - 파일 간 환자 중복 분석
  - 데이터 품질 평가
  - 영어 시각화 생성

### 4.6 결론 및 권장사항

1. **데이터 통합 시 주의사항**: 각 파일이 서로 다른 환자 고유번호 체계를 사용하므로, 환자 매칭 시 이름 기반 매칭이 필요할 수 있습니다.

2. **데이터 품질**: LIS를 제외하고는 고유번호 누락이 거의 없어 데이터 품질이 양호합니다.

3. **분석 우선순위**: PACS와 LIS가 가장 많은 환자 데이터를 보유하므로, 이 두 파일을 중심으로 한 분석이 유용할 것입니다.

4. **시각화 활용**: 영어로 생성된 시각화 자료는 논문이나 보고서 작성 시 활용 가능합니다.